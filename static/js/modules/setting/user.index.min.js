"use strict";

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var UserIndex =
/*#__PURE__*/
function () {
  function UserIndex() {
    _classCallCheck(this, UserIndex);

    this.table = new TablePlugin("#tbUsers");
    this.ajax = new AjaxPlugin();
    this.form = new FormPlugin();
    this.alert = new AlertPlugin();
    this.$modalCreate = new ModalPlugin("#md-manage-create");
    this.$modalUpdate = new ModalPlugin("#md-manage-update");
    this.config = $.extend(true, {}, APP);
    this.url = {
      list: "".concat(this.config.url.controllerFullUrl, "/list"),
      update: "".concat(this.config.url.controllerFullUrl, "/update"),
      create: "".concat(this.config.url.controllerFullUrl, "/create"),
      "delete": "".concat(this.config.url.controllerFullUrl, "/delete")
    };
  }

  _createClass(UserIndex, [{
    key: "_submitCreate",
    value: function _submitCreate(form) {
      var _this = this;

      this.ajax.post(this.url.create, $(form).serialize()).then(function (response) {
        _this.table.refresh();

        _this.$modalCreate.close();

        Notify("success", response.data.message, "bottomRight");
      })["catch"](function (error) {
        Notify("error", error.data.message, "bottomRight");
      });
    }
  }, {
    key: "_submitUpdate",
    value: function _submitUpdate(form) {
      var _this2 = this;

      this.ajax.post(this.url.update, $(form).serialize()).then(function (response) {
        _this2.table.refresh();

        _this2.$modalUpdate.close();

        Notify("success", response.data.message, "bottomRight");
      })["catch"](function (error) {
        Notify("error", error.data.message, "bottomRight");
      });
    }
  }, {
    key: "_deleteUser",
    value: function _deleteUser(row) {
      var _this3 = this;

      this.alert.confirm({
        title: "¡Advertencia!",
        text: "Va a eliminar el usuario <strong>\"".concat(row.uname, "\"</strong>"),
        type: "warning"
      }, function () {
        _this3.ajax.post(_this3.url["delete"], _this3.form.create({
          urid: row.urid
        })).then(function (response) {
          _this3.table.refresh();

          Notify("success", response.data.message, "bottomRight");
        })["catch"](function (error) {
          Notify("error", error.data.message, "bottomRight");
        });
      });
    }
  }, {
    key: "initModalCreate",
    value: function initModalCreate() {
      var _this4 = this;

      this.$modalCreate.setOptions({
        title: 'Nuevo Registro',
        buttonInit: "#btn-create",
        form: "#form-manage-create",
        buttonCancel: '#btn-close',
        buttonSubmit: '#btn-save',
        formValidate: {
          rules: {
            "User[uname]": {
              required: true
            },
            "User[rid]": {
              required: true
            }
          }
        },
        onBeforeShow: function onBeforeShow() {
          _this4.$modalCreate.$form.find("#User_rid").select2({
            language: "es",
            placeholder: 'Seleccione...',
            dropdownParent: _this4.$modalCreate.$modal
          });

          _this4.$modalCreate.$form.find("#cbo_id_permiso_usuario").select2({
            language: "es",
            ajax: {
              url: "".concat(_this4.config.url.controllerFullUrl, "/listPersonal"),
              dataType: 'json',
              delay: 250,
              allowClear: true,
              processResults: function processResults(data) {
                return {
                  results: data.response.items,
                  pagination: {
                    more: false
                  }
                };
              }
            },
            placeholder: 'Seleccione Trabajador',
            escapeMarkup: function escapeMarkup(markup) {
              return markup;
            },
            // let our custom formatter work
            minimumInputLength: 3,
            templateResult: function templateResult(repo) {
              var markup = "<div class='select2-result-repository clearfix'>" + "<div class='select2-result-repository__title fs-10'>" + repo.text + "</div></div>";
              return markup;
            },
            templateSelection: function templateSelection(repo) {
              return repo.text;
            },
            dropdownParent: _this4.$modalCreate.$modal
          });
        },
        onAfterHide: function onAfterHide() {
          var $cboRid = _this4.$modalCreate.$form.find("#User_rid");

          var $cboUsuario = _this4.$modalCreate.$form.find("#cbo_id_permiso_usuario");

          if ($cboUsuario.hasClass("select2-hidden-accessible")) {
            // Select2 has been initialized
            $cboUsuario.select2('destroy');
          }

          if ($cboRid.hasClass("select2-hidden-accessible")) {
            // Select2 has been initialized
            $cboRid.select2('destroy');
          }
        }
      });
      this.$modalCreate.init();
      this.$modalCreate.submit(function (form) {
        _this4._submitCreate(form);
      });
    }
  }, {
    key: "initModalUpdate",
    value: function initModalUpdate() {
      var _this5 = this;

      this.$modalUpdate.setOptions({
        title: 'Actualizar Registro',
        buttonInit: false,
        form: "#form-manage-update",
        buttonCancel: '#btn-close',
        buttonSubmit: '#btn-save',
        formValidate: {
          rules: {
            "User[rid]": {
              required: true
            }
          }
        },
        onBeforeShow: function onBeforeShow() {
          _this5.$modalUpdate.$form.find("#User_rid").select2({
            language: "es",
            //        placeholder: 'Seleccione...',
            dropdownParent: _this5.$modalUpdate.$modal
          }).trigger('change');
        }
      });
      this.$modalUpdate.init();
      this.$modalUpdate.submit(function (form) {
        _this5._submitUpdate(form);
      });
    }
  }, {
    key: "initTable",
    value: function initTable() {
      var _this6 = this;

      this.table.setOptions({
        url: this.url.list,
        pageSize: 10
      });
      this.table.columns([{
        field: 'urid',
        title: 'ID',
        sortable: true,
        align: 'center',
        width: '70px',
        "class": 'bold'
      }, {
        field: 'uname',
        title: 'Identificación del Usuario',
        sortable: true
      }, {
        field: 'nombres',
        title: 'Nombre Completo del Usuario',
        sortable: true
      }, {
        field: 'rname',
        title: 'Nombre del Rol',
        sortable: true
      }, {
        field: 'action',
        title: '<i class="fa fa-ellipsis-h" aria-hidden="true"></i>',
        align: 'center',
        width: '70px',
        formatter: function formatter(value, row, index, field) {
          return "\n          <div class=\"wrapper text-center\" role=\"toolbar\">\n            <div class=\"btn-group btn-group-sm\" role=\"group\">\n              <button \n                type=\"button\" \n                class=\"edit btn btn-outline-info\" \n                data-action=\"modify\" \n                data-rel=\"tooltip\" \n                title=\"Editar\">\n                <i class=\"fa fa-pencil\" aria-hidden=\"true\"></i>\n              </button>\n              <button \n                type=\"button\" \n                class=\"delete btn btn-outline-danger\" \n                data-rel=\"tooltip\" \n                title=\"Editar\">\n                <i class=\"fa fa-trash\" aria-hidden=\"true\"></i>\n              </button>\n            </div>\n          </div>\n          ";
        },
        events: {
          'click .edit': function clickEdit(e, value, row, index) {
            _this6.$modalUpdate.setData(row);

            _this6.$modalUpdate.open();
          },
          'click .delete': function clickDelete(e, value, row, index) {
            _this6._deleteUser(row);
          }
        }
      }]);
      this.table.init();
    }
  }, {
    key: "init",
    value: function init() {
      this.initTable();
      this.initModalCreate();
      this.initModalUpdate();
    }
  }]);

  return UserIndex;
}();

$(function () {
  new UserIndex().init();
});